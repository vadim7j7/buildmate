# Next.js Internationalization Patterns

i18n patterns using next-intl for multilingual applications.

---

## 1. Setup

### Installation

```bash
npm install next-intl
```

### Configuration

```typescript
// i18n/config.ts
export const locales = ['en', 'es', 'fr', 'de'] as const;
export type Locale = (typeof locales)[number];

export const defaultLocale: Locale = 'en';

export const localeNames: Record<Locale, string> = {
  en: 'English',
  es: 'Español',
  fr: 'Français',
  de: 'Deutsch',
};
```

### Request Configuration

```typescript
// i18n/request.ts
import { getRequestConfig } from 'next-intl/server';
import { locales, defaultLocale, type Locale } from './config';

export default getRequestConfig(async ({ requestLocale }) => {
  let locale = await requestLocale;

  if (!locale || !locales.includes(locale as Locale)) {
    locale = defaultLocale;
  }

  return {
    locale,
    messages: (await import(`../messages/${locale}.json`)).default,
  };
});
```

---

## 2. Directory Structure

```
app/
├── [locale]/
│   ├── layout.tsx
│   ├── page.tsx
│   └── dashboard/
│       └── page.tsx
├── api/
│   └── ...
messages/
├── en.json
├── es.json
├── fr.json
└── de.json
i18n/
├── config.ts
├── request.ts
└── navigation.ts
middleware.ts
```

---

## 3. Message Files

```json
// messages/en.json
{
  "common": {
    "loading": "Loading...",
    "error": "An error occurred",
    "save": "Save",
    "cancel": "Cancel",
    "delete": "Delete",
    "edit": "Edit"
  },
  "navigation": {
    "home": "Home",
    "dashboard": "Dashboard",
    "settings": "Settings",
    "logout": "Log out"
  },
  "auth": {
    "login": {
      "title": "Sign in to your account",
      "email": "Email address",
      "password": "Password",
      "submit": "Sign in",
      "forgotPassword": "Forgot your password?",
      "noAccount": "Don't have an account?",
      "signUp": "Sign up"
    },
    "register": {
      "title": "Create your account",
      "name": "Full name",
      "email": "Email address",
      "password": "Password",
      "confirmPassword": "Confirm password",
      "submit": "Create account",
      "hasAccount": "Already have an account?",
      "signIn": "Sign in"
    }
  },
  "dashboard": {
    "welcome": "Welcome, {name}!",
    "stats": {
      "posts": "{count, plural, =0 {No posts} one {# post} other {# posts}}",
      "views": "{count, number} views",
      "lastUpdated": "Last updated {date, date, medium}"
    }
  },
  "errors": {
    "required": "{field} is required",
    "email": "Please enter a valid email address",
    "minLength": "{field} must be at least {min} characters",
    "maxLength": "{field} must be at most {max} characters"
  }
}
```

```json
// messages/es.json
{
  "common": {
    "loading": "Cargando...",
    "error": "Ha ocurrido un error",
    "save": "Guardar",
    "cancel": "Cancelar",
    "delete": "Eliminar",
    "edit": "Editar"
  },
  "navigation": {
    "home": "Inicio",
    "dashboard": "Panel",
    "settings": "Configuración",
    "logout": "Cerrar sesión"
  }
}
```

---

## 4. Middleware

```typescript
// middleware.ts
import createMiddleware from 'next-intl/middleware';
import { locales, defaultLocale } from '@/i18n/config';

export default createMiddleware({
  locales,
  defaultLocale,
  localePrefix: 'as-needed',
});

export const config = {
  matcher: ['/', '/(en|es|fr|de)/:path*'],
};
```

---

## 5. Navigation Helper

```typescript
// i18n/navigation.ts
import { createNavigation } from 'next-intl/navigation';
import { locales, defaultLocale } from './config';

export const { Link, redirect, usePathname, useRouter } = createNavigation({
  locales,
  defaultLocale,
  localePrefix: 'as-needed',
});
```

---

## 6. Root Layout

```typescript
// app/[locale]/layout.tsx
import { NextIntlClientProvider } from 'next-intl';
import { getMessages, setRequestLocale } from 'next-intl/server';
import { locales, type Locale } from '@/i18n/config';

export function generateStaticParams() {
  return locales.map((locale) => ({ locale }));
}

type Props = {
  children: React.ReactNode;
  params: Promise<{ locale: Locale }>;
};

export default async function LocaleLayout({ children, params }: Props) {
  const { locale } = await params;
  setRequestLocale(locale);

  const messages = await getMessages();

  return (
    <html lang={locale}>
      <body>
        <NextIntlClientProvider messages={messages}>
          {children}
        </NextIntlClientProvider>
      </body>
    </html>
  );
}
```

---

## 7. Server Components

```typescript
// app/[locale]/dashboard/page.tsx
import { getTranslations, setRequestLocale } from 'next-intl/server';
import type { Locale } from '@/i18n/config';

type Props = {
  params: Promise<{ locale: Locale }>;
};

export async function generateMetadata({ params }: Props) {
  const { locale } = await params;
  const t = await getTranslations({ locale, namespace: 'dashboard' });

  return {
    title: t('title'),
  };
}

export default async function DashboardPage({ params }: Props) {
  const { locale } = await params;
  setRequestLocale(locale);

  const t = await getTranslations('dashboard');
  const user = await getCurrentUser();

  return (
    <div>
      <h1>{t('welcome', { name: user.name })}</h1>

      <div className="stats">
        <p>{t('stats.posts', { count: user.postsCount })}</p>
        <p>{t('stats.views', { count: user.viewsCount })}</p>
        <p>{t('stats.lastUpdated', { date: new Date(user.updatedAt) })}</p>
      </div>
    </div>
  );
}
```

---

## 8. Client Components

```typescript
// components/ContactForm.tsx
'use client';

import { useTranslations } from 'next-intl';
import { useState } from 'react';

export function ContactForm() {
  const t = useTranslations('contact');
  const tErrors = useTranslations('errors');
  const [errors, setErrors] = useState<Record<string, string>>({});

  const validate = (data: FormData) => {
    const newErrors: Record<string, string> = {};

    if (!data.get('name')) {
      newErrors.name = tErrors('required', { field: t('form.name') });
    }

    if (!data.get('email')) {
      newErrors.email = tErrors('required', { field: t('form.email') });
    }

    setErrors(newErrors);
    return Object.keys(newErrors).length === 0;
  };

  return (
    <form>
      <div>
        <label>{t('form.name')}</label>
        <input name="name" />
        {errors.name && <span className="error">{errors.name}</span>}
      </div>

      <div>
        <label>{t('form.email')}</label>
        <input name="email" type="email" />
        {errors.email && <span className="error">{errors.email}</span>}
      </div>

      <button type="submit">{t('form.submit')}</button>
    </form>
  );
}
```

---

## 9. Language Switcher

```typescript
// components/LanguageSwitcher.tsx
'use client';

import { useLocale } from 'next-intl';
import { usePathname, useRouter } from '@/i18n/navigation';
import { locales, localeNames, type Locale } from '@/i18n/config';

export function LanguageSwitcher() {
  const locale = useLocale();
  const router = useRouter();
  const pathname = usePathname();

  const handleChange = (newLocale: Locale) => {
    router.replace(pathname, { locale: newLocale });
  };

  return (
    <select
      value={locale}
      onChange={(e) => handleChange(e.target.value as Locale)}
    >
      {locales.map((loc) => (
        <option key={loc} value={loc}>
          {localeNames[loc]}
        </option>
      ))}
    </select>
  );
}
```

---

## 10. Formatted Values

```typescript
// components/FormattedValues.tsx
'use client';

import { useFormatter, useNow, useTimeZone } from 'next-intl';

export function FormattedValues() {
  const format = useFormatter();
  const now = useNow();
  const timeZone = useTimeZone();

  return (
    <div>
      {/* Numbers */}
      <p>{format.number(1234.56)}</p>
      <p>{format.number(1234.56, { style: 'currency', currency: 'USD' })}</p>
      <p>{format.number(0.456, { style: 'percent' })}</p>

      {/* Dates */}
      <p>{format.dateTime(now, { dateStyle: 'full' })}</p>
      <p>{format.dateTime(now, { timeStyle: 'short' })}</p>
      <p>{format.relativeTime(new Date('2024-01-01'))}</p>

      {/* Lists */}
      <p>{format.list(['Apple', 'Banana', 'Orange'])}</p>
    </div>
  );
}
```

---

## 11. API Routes

```typescript
// app/api/posts/route.ts
import { getTranslations } from 'next-intl/server';
import { NextRequest, NextResponse } from 'next/server';

export async function POST(request: NextRequest) {
  // Get locale from header or query
  const locale = request.headers.get('Accept-Language')?.split(',')[0] || 'en';

  const t = await getTranslations({ locale, namespace: 'api' });

  try {
    // ... create post logic

    return NextResponse.json({
      message: t('post.created'),
      data: post,
    });
  } catch (error) {
    return NextResponse.json(
      { error: t('errors.createFailed') },
      { status: 500 }
    );
  }
}
```

---

## 12. Testing

```typescript
// __tests__/i18n.test.tsx
import { render, screen } from '@testing-library/react';
import { NextIntlClientProvider } from 'next-intl';
import messages from '@/messages/en.json';
import { DashboardStats } from '@/components/DashboardStats';

const Wrapper = ({ children }: { children: React.ReactNode }) => (
  <NextIntlClientProvider locale="en" messages={messages}>
    {children}
  </NextIntlClientProvider>
);

describe('DashboardStats', () => {
  it('formats plural correctly', () => {
    render(
      <Wrapper>
        <DashboardStats postsCount={0} />
      </Wrapper>
    );
    expect(screen.getByText('No posts')).toBeInTheDocument();
  });

  it('formats singular correctly', () => {
    render(
      <Wrapper>
        <DashboardStats postsCount={1} />
      </Wrapper>
    );
    expect(screen.getByText('1 post')).toBeInTheDocument();
  });

  it('formats plural correctly', () => {
    render(
      <Wrapper>
        <DashboardStats postsCount={5} />
      </Wrapper>
    );
    expect(screen.getByText('5 posts')).toBeInTheDocument();
  });
});
```
